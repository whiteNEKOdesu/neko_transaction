## 开发配置

### docker

#### seata

- 镜像拉取

```bash
docker pull seataio/seata-server:2.0.0-slim
```



- 指定seata-server IP和端口 启动

```bash
docker run --name neko-transaction-seata \
        -p 8091:8091 \
        -p 7091:7091 \
        -e SEATA_IP=192.168.30.131 \
        -e SEATA_PORT=8091 \
        -v /usr/local/neko_transaction/backend/docker_data/seata/resources:/seata-server/resources \
        -d \
        seataio/seata-server:2.0.0-slim
```



- 自定义配置文件

定义配置文件需要通过挂载文件的方式实现，将宿主机上的 application.yml 挂载到容器中相应的目录

```bash
docker run -d -p 8091:8091 -p 7091:7091  --name seata-serve seataio/seata-server:latest
docker cp seata-serve:/seata-server/resources /User/seata/config
```



##### 环境变量

- **SEATA_IP**

> 可选, 指定seata-server启动的IP, 该IP用于向注册中心注册时使用, 如eureka等

- **SEATA_PORT**

> 可选, 指定seata-server启动的端口, 默认为 `8091`

- **STORE_MODE**

> 可选, 指定seata-server的事务日志存储方式, 支持`db` ,`file`,redis(Seata-Server 1.3及以上版本支持), 默认是 `file`

- **SERVER_NODE**

> 可选, 用于指定seata-server节点ID, 如 `1`,`2`,`3`..., 默认为 `根据ip生成`

- **SEATA_ENV**

> 可选, 指定 seata-server 运行环境, 如 `dev`, `test` 等, 服务启动时会使用 `registry-dev.conf` 这样的配置

- **SEATA_CONFIG_NAME**

> 可选, 指定配置文件位置, 如 `file:/root/registry`, 将会加载 `/root/registry.conf` 作为配置文件，如果需要同时指定 `file.conf`文件，需要将`registry.conf`的`config.file.name`的值改为类似`file:/root/file.conf`：



#### nacos

##### 镜像制作

```dockerfile
FROM adoptopenjdk/openjdk8:x86_64-ubuntu-jdk8u382-b05
MAINTAINER NEKO<NEKO@NEKO.com>
EXPOSE 8848

WORKDIR /app/nacos

ADD ./nacos  /app/nacos
ENTRYPOINT ["bash","bin/startup.sh","-m","standalone"]
```



- 构建镜像

```bash
docker build -t neko-nacos:1.0 .
```



#### 后端服务

##### 镜像制作

```dockerfile
FROM eclipse-temurin:17.0.10_7-jre-alpine
MAINTAINER NEKO<NEKO@NEKO.com>

WORKDIR /app

VOLUME /tmp
ADD *.jar  /app/app.jar
ENTRYPOINT ["java","-jar","app.jar"]
```



- 构建镜像

```bash
docker build -t $name:$version .
```



### ElasticSearch

#### 创建索引

- 添加索引
- put请求

```bash
$baseUrl/neko_transaction_product
```



- 请求体添加mapping映射

```json
{
    "mappings": {
        "properties": {
            "productId": {
                "type": "long"
            },
            "uid": {
                "type": "keyword"
            },
            "userName": {
                "type": "keyword"
            },
            "realName": {
                "type": "keyword"
            },
            "categoryId": {
                "type": "integer"
            },
            "fullCategoryName": {
                "type": "text",
                "analyzer": "ik_smart"
            },
            "productName": {
                "type": "text",
                "analyzer": "ik_smart"
            },
            "description": {
                "type": "text",
                "analyzer": "ik_smart"
            },
            "displayImage": {
                "type": "keyword"
            },
            "price": {
                "type": "scaled_float",
                "scaling_factor": 100
            },
            "upTime": {
                "type": "date",
                "format": "yyyy-MM-dd HH:mm:ss"
            },
            "saleNumber": {
                "type": "integer"
            }
        }
    }
}
```



#### 商品查询

```json
{
    "query": {
        "bool": {
            "must": [
                {
                    "match": {
                        "description": "插画"
                    }
                }
            ],
            "filter": [
                {
                    "match": {
                        "uid": "1642067605873348610"
                    }
                },
                {
                    "term": {
                        "categoryId": 17
                    }
                },
                {
                    "range": {
                        "upTime": {
                            "gte": "2023-07-17 11:29:49",
                            "lte": "2024-05-17 11:35:41"
                        }
                    }
                },
                {
                    "range": {
                        "price": {
                            "gte": 0,
                            "lte": 15
                        }
                    }
                }
            ],
            "should": [
                {
                    "match": {
                        "productName": "插画"
                    }
                },
                {
                    "match": {
                        "categoryName": "插画"
                    }
                },
                {
                    "match": {
                        "userName": "NEKO"
                    }
                },
                {
                    "match": {
                        "realName": "NEKO"
                    }
                }
            ]
        }
    },
    "sort": {
        "price": {
            "order": "desc"
        },
        "upTime": {
            "order": "desc"
        }
    },
    "highlight": {
        "fields": {
            "description": {},
            "productName": {}
        },
        "pre_tags": "<b style='color:red'>",
        "post_tags": "</b>"
    },
    "from": 0,
    "size": 8
}
```

